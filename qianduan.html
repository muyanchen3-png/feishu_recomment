<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ä¿¡æ¯æ¨é€ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: block;
            margin: 0 auto;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .theme-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .theme-tag {
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .theme-tag:hover {
            background: #667eea;
            color: white;
        }
        
        .selected {
            background: #667eea;
            color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½ä¿¡æ¯æ¨é€ç³»ç»Ÿ</h1>
            <p>è‡ªåŠ¨è·å–å¾®åšä¿¡æ¯å¹¶æ¨é€åˆ°é£ä¹¦</p>
        </div>
        
        <div class="form-container">
            <form id="pushForm">
                <!-- å¾®åšæ‰‹æœºå·ç™»å½• -->
                <div class="form-group">
                    <label for="phone">å¾®åšæ‰‹æœºå·</label>
                    <input type="tel" id="phone" name="phone" placeholder="è¯·è¾“å…¥å¾®åšæ³¨å†Œæ‰‹æœºå·" required>
                    <button type="button" id="loginBtn" class="submit-btn" style="display: inline-block; width: auto; margin-top: 10px;">æ‰‹æœºå·ç™»å½•å¹¶è·å–Cookie</button>
                </div>

                <div class="form-group" id="cookieStatus" style="display: none;">
                    <label>CookieçŠ¶æ€</label>
                    <p id="cookieMessage"></p>
                    <textarea id="manualCookie" name="manualCookie" placeholder="å¯é€‰: æ‰‹åŠ¨è¾“å…¥Cookie (å¦‚æœè‡ªåŠ¨è·å–çš„Cookieå¤±æ•ˆ)" style="margin-top: 10px; height: 60px; resize: vertical;"></textarea>
                    <button type="button" id="updateCookieBtn" class="submit-btn" style="display: inline-block; width: auto; margin-top: 10px; background: #28a745;">æ›´æ–°Cookie</button>
                    <button type="button" id="saveManualCookieBtn" class="submit-btn" style="display: inline-block; width: auto; margin-top: 10px; margin-left: 10px; background: #007bff;">ä¿å­˜æ‰‹åŠ¨Cookie</button>
                </div>
                
                <!-- æ¨é€ä¸»é¢˜è®¾ç½® -->
                <div class="form-group">
                    <label>æ¨é€ä¸»é¢˜</label>
                    <div class="theme-tags">
                        <span class="theme-tag" data-value="ç§‘æŠ€">ç§‘æŠ€</span>
                        <span class="theme-tag" data-value="å¨±ä¹">å¨±ä¹</span>
                        <span class="theme-tag" data-value="ä½“è‚²">ä½“è‚²</span>
                        <span class="theme-tag" data-value="è´¢ç»">è´¢ç»</span>
                        <span class="theme-tag" data-value="æ±½è½¦">æ±½è½¦</span>
                        <span class="theme-tag" data-value="æˆ¿äº§">æˆ¿äº§</span>
                        <span class="theme-tag" data-value="æ•™è‚²">æ•™è‚²</span>
                        <span class="theme-tag" data-value="æ¸¸æˆ">æ¸¸æˆ</span>
                        <span class="theme-tag" data-value="æ—…æ¸¸">æ—…æ¸¸</span>
                        <span class="theme-tag" data-value="ç¾é£Ÿ">ç¾é£Ÿ</span>
                    </div>
                    <textarea id="customTopics" name="customTopics" placeholder="è¾“å…¥è‡ªå®šä¹‰ä¸»é¢˜å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”" style="margin-top: 15px; height: 80px;"></textarea>
                </div>
                
                <!-- æ¨é€æ—¶é—´è®¾ç½® -->
                <div class="form-group">
                    <label for="pushTime">æ¯æ—¥æ¨é€æ—¶é—´</label>
                    <select id="pushTime" name="pushTime" required>
                        <option value="">è¯·é€‰æ‹©æ¨é€æ—¶é—´</option>
                        <option value="test_10s" style="color: red;">ğŸ”¥ 10ç§’åæµ‹è¯•æ¨é€</option>
                        <option value="08:00">ä¸Šåˆ 8:00</option>
                        <option value="09:00">ä¸Šåˆ 9:00</option>
                        <option value="10:00">ä¸Šåˆ 10:00</option>
                        <option value="11:00">ä¸Šåˆ 11:00</option>
                        <option value="12:00">ä¸­åˆ 12:00</option>
                        <option value="14:00">ä¸‹åˆ 2:00</option>
                        <option value="15:00">ä¸‹åˆ 3:00</option>
                        <option value="16:00">ä¸‹åˆ 4:00</option>
                        <option value="17:00">ä¸‹åˆ 5:00</option>
                        <option value="18:00">ä¸‹åˆ 6:00</option>
                        <option value="19:00">æ™šä¸Š 7:00</option>
                        <option value="20:00">æ™šä¸Š 8:00</option>
                    </select>
                </div>
                
                <!-- é£ä¹¦Webhookè®¾ç½® -->
                <div class="form-group">
                    <label for="feishuWebhook">é£ä¹¦æœºå™¨äººWebhook</label>
                    <input type="url" id="feishuWebhook" name="feishuWebhook" placeholder="è¯·è¾“å…¥é£ä¹¦æœºå™¨äººWebhookåœ°å€" required>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                        <strong>è·å–æ–¹æ³•ï¼š</strong>åœ¨é£ä¹¦ç¾¤èŠä¸­æ·»åŠ æœºå™¨äºº â†’ å¤åˆ¶Webhookåœ°å€
                    </div>
                </div>
                
                <!-- æ¨é€é¢‘ç‡è®¾ç½® -->
                <div class="form-group">
                    <label>æ¨é€é¢‘ç‡</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="daily" name="frequency" value="daily" checked>
                        <label for="daily">æ¯æ—¥æ¨é€</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="weekly" name="frequency" value="weekly">
                        <label for="weekly">æ¯å‘¨æ¨é€</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="custom" name="frequency" value="custom">
                        <label for="custom">è‡ªå®šä¹‰æ¨é€</label>
                    </div>
                </div>
                
                <!-- æ¶ˆæ¯æ ¼å¼è®¾ç½® -->
                <div class="form-group">
                    <label>æ¶ˆæ¯æ ¼å¼</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeImages" name="messageFormat" value="images" checked>
                        <label for="includeImages">åŒ…å«å›¾ç‰‡</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeComments" name="messageFormat" value="comments">
                        <label for="includeComments">åŒ…å«è¯„è®ºæ•°</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeLikes" name="messageFormat" value="likes" checked>
                        <label for="includeLikes">åŒ…å«ç‚¹èµæ•°</label>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn">ä¿å­˜è®¾ç½®å¹¶å¯åŠ¨æ¨é€</button>
            </form>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        let currentPhone = '';
        let currentCookie = '';

        // ä¸»é¢˜æ ‡ç­¾é€‰æ‹©åŠŸèƒ½
        document.querySelectorAll('.theme-tag').forEach(tag => {
            tag.addEventListener('click', function() {
                this.classList.toggle('selected');
            });
        });

        // æ‰‹æœºå·ç™»å½•å¹¶è·å–cookie
        document.getElementById('loginBtn').addEventListener('click', async function() {
            const phone = document.getElementById('phone').value;
            if (!phone) {
                showStatus('è¯·è¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }

            currentPhone = phone;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();
                if (response.ok) {
                    currentCookie = data.cookie;
                    document.getElementById('cookieStatus').style.display = 'block';
                    document.getElementById('cookieMessage').textContent = 'Cookieè·å–æˆåŠŸï¼';
                    showStatus('ç™»å½•æˆåŠŸï¼Œè¯·é…ç½®æ¨é€è®¾ç½®', 'success');
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('pushForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!currentCookie) {
                showStatus('è¯·å…ˆé€šè¿‡æ‰‹æœºå·ç™»å½•è·å–Cookie', 'error');
                return;
            }

            // è·å–é€‰ä¸­çš„ä¸»é¢˜
            const selectedThemes = Array.from(document.querySelectorAll('.theme-tag.selected'))
                .map(tag => tag.dataset.value);

            const customTopics = document.getElementById('customTopics').value;
            const allTopics = [...selectedThemes];

            if (customTopics.trim()) {
                const custom = customTopics.split(',').map(topic => topic.trim()).filter(topic => topic);
                allTopics.push(...custom);
            }

            // éªŒè¯è¡¨å•æ•°æ®
            const formData = {
                phone: currentPhone,
                cookie: currentCookie,
                push_time: document.getElementById('pushTime').value,
                feishu_webhook: document.getElementById('feishuWebhook').value,
                keywords: allTopics
            };

            // è°ƒè¯•ä¿¡æ¯
            console.log('å‘é€çš„æ•°æ®:', formData);

            if (!currentPhone) {
                showStatus('è¯·å…ˆè¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }

            if (!currentCookie) {
                showStatus('è¯·å…ˆç‚¹å‡»æ‰‹æœºå·ç™»å½•è·å–Cookie', 'error');
                return;
            }

            if (!formData.push_time) {
                showStatus('è¯·é€‰æ‹©æ¨é€æ—¶é—´', 'error');
                return;
            }

            if (!formData.feishu_webhook) {
                showStatus('è¯·è¾“å…¥é£ä¹¦æœºå™¨äººWebhookåœ°å€', 'error');
                return;
            }

            if (!formData.keywords.length) {
                showStatus('è¯·è‡³å°‘é€‰æ‹©æˆ–è¾“å…¥ä¸€ä¸ªå…³é”®è¯', 'error');
                return;
            }

            try {
                const response = await fetch('/api/save_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (response.ok) {
                    showStatus(data.message, 'success');
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // æ›´æ–°Cookie (é‡æ–°è·å–)
        document.getElementById('updateCookieBtn').addEventListener('click', async function() {
            if (!currentPhone) {
                showStatus('è¯·å…ˆè¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: currentPhone })
                });

                const data = await response.json();
                if (response.ok) {
                    currentCookie = data.cookie;
                    document.getElementById('cookieMessage').textContent = 'Cookieæ›´æ–°æˆåŠŸï¼';

                    // å¦‚æœconfigå·²ä¿å­˜åˆ™æ›´æ–°æ•°æ®åº“ä¸­çš„cookie
                    if (document.querySelector('#pushForm input[name="feishuWebhook"]').value) {
                        await fetch('/api/update_cookie', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                phone: currentPhone,
                                cookie: data.cookie
                            })
                        });
                        showStatus('CookieæˆåŠŸæ›´æ–°åˆ°æ•°æ®åº“', 'success');
                    } else {
                        showStatus('Cookieå·²æ›´æ–°ï¼Œè¯·é…ç½®å…¶ä»–è®¾ç½®åä¿å­˜', 'success');
                    }
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('Cookieæ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });

        // ä¿å­˜æ‰‹åŠ¨Cookie
        document.getElementById('saveManualCookieBtn').addEventListener('click', async function() {
            const manualCookie = document.getElementById('manualCookie').value.trim();

            if (!manualCookie) {
                showStatus('è¯·å…ˆè¾“å…¥Cookieå†…å®¹', 'error');
                return;
            }

            if (!currentPhone) {
                showStatus('è¯·å…ˆè¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }

            try {
                const response = await fetch('/api/update_cookie', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: currentPhone,
                        cookie: manualCookie
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    currentCookie = manualCookie;
                    document.getElementById('cookieMessage').textContent = 'æ‰‹åŠ¨Cookieä¿å­˜æˆåŠŸï¼';
                    showStatus('æ‰‹åŠ¨Cookieå·²ç»ä¿å­˜åˆ°æ•°æ®åº“', 'success');
                } else {
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                showStatus('æ‰‹åŠ¨Cookieä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ™ºèƒ½ä¿¡æ¯æ¨é€ç³»ç»Ÿå·²å°±ç»ª');
        });
    </script>
</body>
</html>
